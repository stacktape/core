# GitHub Actions Release Workflow

This document explains how to use the GitHub Actions workflow for automated releases.

## Overview

The release workflow builds binaries on native platforms (Linux, macOS, Windows, Alpine) and publishes releases to GitHub and npm. This ensures binaries are compiled natively rather than cross-compiled.

## Prerequisites

### 1. GitHub Repository Secrets

Add the following secret to your GitHub repository:
- `STACKTAPE_API_KEY` - Your Stacktape API key for AWS operations (publishing install scripts and schemas)

To add the secret:
1. Go to your repository on GitHub
2. Navigate to Settings → Secrets and variables → Actions
3. Click "New repository secret"
4. Name: `STACKTAPE_API_KEY`
5. Value: Your Stacktape API key
6. Click "Add secret"

**Note:** The workflow uses GitHub's built-in `GITHUB_TOKEN` for creating releases and pushing commits. No additional GitHub token setup is required.

### 2. npm Trusted Publisher Setup

Configure the npm package to accept publishes from GitHub Actions using OIDC (no npm token required):

1. Go to https://www.npmjs.com/package/stacktape/access
2. Navigate to "Publishing access" → "Trusted publishers"
3. Click "Add trusted publisher"
4. Configure for GitHub Actions:
   - **Provider**: GitHub
   - **Organization/User**: `stacktape`
   - **Repository**: `core`
   - **Workflow filename**: `release.yml`
   - **Environment name**: (leave empty or specify if using GitHub environments)
5. Save the configuration

This eliminates the need for npm tokens and uses short-lived OIDC tokens automatically generated by GitHub Actions.

## Usage

### Triggering a Release

Use the `release:gh` script to trigger the workflow:

```bash
# Release with explicit version
bun run release:gh --version 2.23.0

# Auto-increment version
bun run release:gh --minor
bun run release:gh --major
bun run release:gh --patch

# Prerelease
bun run release:gh --patch --prerelease
```

The script will:
1. Trigger the GitHub Actions workflow on the current branch
2. Pass version and prerelease parameters
3. Show a link to monitor the workflow run

### Workflow Steps

The workflow consists of three jobs:

#### 1. Determine Version
- Determines the version to release based on inputs
- Outputs version for other jobs to use

#### 2. Build Binaries (Matrix)
Builds binaries on native platforms:
- **Linux x64**: `ubuntu-latest` with glibc
- **Alpine x64**: `ubuntu-latest` with Docker (musl libc)
- **macOS x64**: `macos-13` (Intel)
- **macOS ARM64**: `macos-14` (Apple Silicon)
- **Windows x64**: `windows-latest`

Each job:
- Builds the native binary for its platform
- Creates an archive (.tar.gz or .zip)
- Uploads the archive as an artifact

#### 3. Release
After all binaries are built:
- Downloads all binary artifacts
- Sets up GitHub token (uses built-in `GITHUB_TOKEN`)
- Installs Stacktape CLI
- Generates starter project metadata (non-prerelease)
- Generates schemas (non-prerelease)
- Builds npm package
- Creates GitHub release with binaries attached (using `GITHUB_TOKEN`)
- Publishes to npm using OIDC (Trusted Publishers) with provenance attestations
- Publishes install scripts to S3 (requires Stacktape CLI with `STACKTAPE_API_KEY`)
- Publishes schemas (non-prerelease, requires Stacktape CLI with `STACKTAPE_API_KEY`)
- Updates package.json versions
- Commits and pushes version bump (using `GITHUB_TOKEN`)

## Monitoring

View workflow runs at:
https://github.com/stacktape/core/actions/workflows/release.yml

## Environment Variables and Authentication

The workflow uses these tokens and variables:

### GitHub Token
- **`GITHUB_TOKEN`** (built-in): Automatically provided by GitHub Actions with `contents: write` permission
- Used for: Creating releases, pushing commits, uploading assets
- No setup required - automatically available in every workflow

### Stacktape API Key
- **`STACKTAPE_API_KEY`** (from GitHub secrets): Your Stacktape API key
- Used for: Authenticating Stacktape CLI for S3 operations (publishing install scripts and schemas)
- Setup: Add as a GitHub repository secret

## npm Publishing with OIDC

npm publishing uses **Trusted Publishers** with OpenID Connect (OIDC):

- **No npm token required**: GitHub Actions automatically generates a short-lived OIDC token
- **id-token: write permission**: Allows the workflow to request OIDC tokens from GitHub
- **Automatic provenance**: The `--provenance` flag generates attestations linking the package to the source code and build

When you run `npm publish --provenance`, npm:
1. Requests an OIDC token from GitHub Actions
2. Authenticates with npm using the trusted publisher configuration
3. Publishes the package with cryptographic provenance attestations

## Troubleshooting

### Workflow fails to trigger
- Ensure `release.yml` exists on the current branch
- Verify the current branch is pushed to remote

### GitHub release creation or commit push fails
- The built-in `GITHUB_TOKEN` is used automatically
- Verify the workflow has `contents: write` permission (already set in the workflow)
- Check that branch protection rules allow the workflow to push commits
- For private repos, ensure Actions have permission to create releases

### Stacktape authentication fails
- Verify `STACKTAPE_API_KEY` is set correctly in GitHub secrets
- Check the API key is valid and has necessary AWS permissions
- Ensure the API key can access S3 buckets for install scripts and schemas

### Build fails on specific platform
- Check the build logs for that platform's job
- Platform-specific issues (e.g., missing dependencies) will show there
- You can re-run failed jobs individually from GitHub Actions UI

### npm publish fails
- **Trusted publisher not configured**: Verify the trusted publisher is set up correctly on npmjs.com for the `stacktape` package
- **Repository mismatch**: Ensure the GitHub org/repo/workflow in npm settings matches `stacktape/core/release.yml`
- **Permission error**: Check that the `id-token: write` permission is present in the workflow
- **Version already exists**: The version may already be published; increment the version
- For prereleases, ensure version follows pattern (alpha|beta|rc).N

### Install scripts publishing fails
- Ensure Stacktape CLI is properly authenticated
- Check AWS permissions for S3 bucket access
- Verify bucket exists and is accessible

## Local Development

To test the build scripts locally:

```bash
# Build binary for current platform
bun run scripts/github-actions/build-platform-binary.ts --platform linux --version 2.23.0-test

# Test version determination
bun run scripts/release/get-version.ts --version 2.23.0-test

# Test npm publish with provenance (requires trusted publisher setup)
cd __release-npm
npm publish --provenance --access public --dry-run
```

## Architecture Notes

- **No validation phase**: The workflow skips linting and type checking to speed up releases. Validation should be done before triggering the release.
- **Native builds**: Each platform builds on its native OS for maximum compatibility.
- **Stacktape integration**: Uses Stacktape CLI for secret management and S3 operations, avoiding direct AWS SDK usage in the workflow.
- **Download-on-install npm**: The npm package downloads binaries on first run rather than bundling platform-specific packages.
- **OIDC authentication for npm**: Uses npm Trusted Publishers with OpenID Connect instead of long-lived tokens. This eliminates token management and provides cryptographic provenance attestations.
